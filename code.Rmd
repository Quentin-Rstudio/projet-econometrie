---
title: "Conscience écologique et dépenses publiques en faveur de l'environnement"
author: "Quentin Merrien, Catherine Berleur et Françoise Berleur"
date: "13/04/2021"
output: 
  html_document : 
    toc : true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

## Packages ----

library(tidyverse)
library(ggforce)
library(sf)
library(haven)
library(FactoMineR)
library(ggrepel)
library(readxl)
library(stargazer)

## Données -----

setwd("C:/Users/quent/Desktop/ENS Paris-Saclay/1A/1S2/Econométrie/TDs/Bases de données/Documents")
# setwd("~/Documents/ENS/econometrie/projet_r")
EVS <- read_dta("ZA7500_v4-0-0.dta")
depenses <-read_xlsx("depenses-env.xlsx")

EVS_env <-EVS %>% 
  select(caseno, year, country, c_abrv, v7, v199, v200, v201, v202, v203, v204) %>%
  mutate(env1 = as.numeric(case_when(v199 %in% c("4","5") ~ "0", 
                          v199 %in% c("1", "2", "3") ~ "1",
                          v199 %in% c("8", "9") ~ "NA")), 
         env2 = as.numeric(case_when(v200 %in% c("1","2") ~ "0", 
                          v200 %in% c("3", "4", "5") ~"1",
                          v200 %in% c("8", "9") ~ "NA")), 
         env3 = as.numeric(case_when(v201 %in% c("1","2") ~ "0", 
                          v201 %in% c("3", "4", "5") ~"1",
                          v201 %in% c("8", "9") ~ "NA")), 
         env4 = as.numeric(case_when(v202 %in% c("1","2") ~ "0", 
                          v202 %in% c("3", "4", "5") ~"1",
                          v202 %in% c("8", "9") ~ "NA")), 
         env5 = as.numeric(case_when(v203 %in% c("1","2") ~ "0", 
                          v203 %in% c("3", "4", "5") ~"1",
                          v203 %in% c("8", "9") ~ "NA")), 
         env6 = as.numeric(case_when(v204 %in% c("1") ~ "1", 
                          v204 %in% c("2") ~"0",
                          v204 %in% c("8", "9") ~ "NA")))%>%
  group_by(country, c_abrv) %>%
  summarize(
            effectif = n_distinct(caseno),
            perc_env = 100*mean(mean(env1 == 1, na.rm = T), mean(env2 == 1, na.rm = T), mean(env3 == 1, na.rm = T), env4 = 100*mean(env4 == 1, na.rm = T), env5 = 100*mean(env5 == 1, na.rm = T)), 
            soutien_pol_env = 100*mean(env6 == 1, na.rm = T))

names(EVS_env)[names(EVS_env)=="c_abrv"] <- "Pays" 
names(EVS_env)[names(EVS_env)=="country"] <- "code"


EVS_et_depenses <- EVS_env %>%
  full_join(depenses, by = "Pays")%>%
  filter(Pays != "NA") %>%
  select(Pays, perc_env, soutien_pol_env, MOI_EUR_2016, PC_GDP_2016) 


eai_data <- read_excel("EAI-data.xlsx")
eai_data <- eai_data %>%
  filter(EAI != "NA")

code_pays <- read_csv("all.csv")

env_et_depenses <- EVS_et_depenses %>%
  full_join(eai_data, by = "code") %>%
  left_join(code_pays, by = c("Pays" = "alpha-2")) %>%
  filter(EAI != "NA", perc_env != "NA", PC_GDP_2016 != "NA") %>%
  group_by(Pays) %>%
  summarize(Nom_pays = first(name), 
            code = first(code), 
            Pays = first(Pays), 
            sensi_env = (perc_env + soutien_pol_env + EAI)/3, 
            perc_env = first(perc_env), 
            soutien_pol_env = first(soutien_pol_env), 
            conn_env = first(EAI), 
            depenses_brutes_env = first(MOI_EUR_2016), 
            part_depenses_env = first(PC_GDP_2016))


gini <- read_excel("GINI_2017.xlsx")

educ_sup <- read_xlsx("education_sup_UE.xlsx", sheet = 3, skip = 11) %>%
  select(TIME, "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")

rev_med <- read_xls("revenu_median_UE.xls", skip = 10)

epi2020results <- read.csv("epi2020results.csv")


  
#regexec() grep()

```

Pour rappel : 
v7 : Tout bien considéré, diriez-vous que vous êtes...  (p.3 de ZA7500_q_fr.pdf)
         1 – Très heureux
         2 – Assez heureux
         3 – Pas très heureux
         4 – Pas heureux du tout

à finir.
Je le ferais. 

  

Point d'analyse intéressant : 
une fois les paramètres économétriques estimés, on peut essayer d'expliquer/interpréter les situations contrefactuelles, c'est-à-dire celles qui s'éloignent le plus de l'estimation. 

Mayda et Rodrik (2005) font une étude économétrique à partir de la WVS, voir p'tet leur méthode. 

Trouver des indicateurs environnementaux supplémentaires : 
https://www.ecosia.org/search?q=indicators+of+environmental+awareness+data+base&addon=chrome&addonversion=3.3.0&method=topbar
http://jultika.oulu.fi/files/nbnfioulu-201312142043.pdf
https://www.oecd.org/env/indicators-modelling-outlooks/data-and-indicators.htm


### I.	Mise en perspective introductive dans le contexte économique et social. 

### II.	Formulation d’un problème économétrique. 

Le premier enjeu se situe dans le choix des variables explicatives. 



### III.	Présentation des bases de données et statistiques descriptives. 

### IV.	Proposition et justification de différents modèles linéaires. 

### V.	Comparaison des coefficients et de la significativité des modèles. 

### VI.	Interprétation et proposition de pistes de réflexion complémentaires (limites blabla).

### VII.	Conclusion. 




## Régression linéaire







```{r linear-regression}
reg1 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env1) # je sais pas quoi faire avec ça, mais à approfondir
reg2 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env6) # je sais pas quoi faire avec ça, mais à approfondir


anova(reg1)
# comparaison de modèles :
anova(reg1,reg2)

reg3 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env1 + env6 + happy + MOI_EUR_2016)

reg4 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env1 + + env2 + env3 + env4 + env5 + env6 + happy + MOI_EUR_2016)

summary(reg4)
summary(reg3)
residuals(reg1)
predict(reg1)

# comment interpréter les résultats d'une régression avec lm : http://www.learnbymarketing.com/tutorials/linear-regression-in-r/

ggplot(data = base_simple_propre, mapping = aes(x = env5, y = PC_GDP_2016)) +
  theme_bw() +
  geom_jitter()+
  geom_smooth(method = lm) + # j'viens de découvrir : pour une droite linéaire, faut mettre method = lm, sinon, loess est pas mal 
  labs(x = "Sensibilité moyenne à l'écologie (env1)", y = "Dépenses environnementales en part de PIB") +
  theme(legend.position = "bottom") +
  scale_color_manual(name = "Les dépenses pour l'environnement sont-elles sensibles à l'opinion publique ?", values =
                       c("black","gray"))+
  guides(color = guide_legend(ncol=2, direction = "horizontal"))


```


```{r tables}

# ça marche PAS, mais c'est chelou un peu

stargazer(reg1, reg2, header = FALSE, type = 'html', notes.label = "Comments", notes = "Pas très significatif toussa, à creuser")

stargazer(base_simple_propre, header = FALSE, type = "html")

# info sur stargazer : https://www.jakeruss.com/cheatsheets/stargazer/ ou
```








## Including Plots


```{r ACP-classification}

## Données ACP et Classification

resultat_ACP <- PCA(db[, 3:9])

dbact<-as_tibble(resultat_ACP$var$coord) %>% 
  mutate(names=c(rownames(resultat_ACP$var$coord)))

dbind<-bind_cols(db,as_tibble(resultat_ACP$ind$coord))

resultat_classif <- HCPC(resultat_ACP, nb.clust = 4, graph = FALSE)

dbind<- dbind %>%
  ungroup() %>%
  mutate(groupe = resultat_classif$data.clust$clust)

europe <- st_read("Europe/europe.shp")

codes <- read.csv("all.csv") %>%
  filter(region == "Europe")%>%
  select(name, alpha.2) %>%
  mutate (NAME = name, 
          c_abrv = alpha.2)
  
carte_europe <- europe %>%
  full_join(codes, by = "NAME")

carte_europe <- carte_europe %>%
  full_join(dbind, by = "c_abrv")

test <-  as.data.frame(carte_europe) %>%
  select(-geometry)


## Graphiques ----

barplot(resultat_ACP$eig[,2],main="Figure I - Part expliquée par chaque axe dans la variance totale",
        names.arg=1:nrow(resultat_ACP$eig),col= rainbow (15))

ggplot(dbact,aes(x=Dim.1,y= Dim.2,label=names))+
  geom_point()+
  theme(legend.title=element_blank(),
        panel.background =element_rect(fill="white")) +
  geom_text(size=4,show.legend = FALSE)+
  geom_hline(yintercept=0,linetype="dashed",colour="grey")+
  geom_vline(xintercept = 0,linetype="dashed",colour="grey")+
  ggtitle("Espace des variables de l'ACP avec les axes 1 et 3") +
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%")) +
  geom_circle( aes(x0 = 0, y0 = 0, r = 1), inherit.aes = F) + 
  scale_x_continuous(limits = c(-1, 1)) +
  scale_y_continuous(limits = c(-1, 1)) +
  coord_fixed() +
  geom_segment(aes(x = 0, y = 0, xend = Dim.1, yend = Dim.2), arrow = arrow())

ggplot(data=dbind,aes(x=Dim.1,y=Dim.2))+
  ggtitle("Titre")+
  geom_point()+
  geom_text_repel(aes(label = c_abrv),size=3)+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme(plot.title=element_text(hjust=0.5),legend.position=c(.95,.2),
        panel.background =element_rect(fill="white"),legend.title=element_blank())+
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%"))

ggplot(data=dbind,aes(x=Dim.1,y=Dim.2))+
  ggtitle("Titre")+
  geom_point(aes(color=groupe))+
  geom_text_repel(aes(color=groupe,label=c_abrv),
                  size=3, max.overlaps = 20, max.iter = 1000)+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme(plot.title=element_text(hjust=0.5),
        panel.background =element_rect(fill="white"))+
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%"))+ 
  guides(color = F)

ggplot(data = carte_europe) +
  geom_sf(aes(fill = groupe)) + 
  guides(fill = F) +
  ggtitle("Figure VI - Carte des pays classifiés selon les opinions agrégées sur l'environnement") +
  coord_sf(datum = NA)





```
## Références théoriques à utiliser

*Courbe de Kuznets environnementale, Grossman (1993), Krueger (1995)*
Corrélation entre développement d’une économie mesurée par le PIB/hab et la diminution de la pollution. Optimisme selon lequel l’amélioration des cond° de vie d’une pop° lui permet, après avoir subvenu à ses besoins primaires, d’améliorer la qualité de son mode de vie et de s’orienter vers des pd° moins polluantes.

*Données expérimentales, Anderson et al. (2008)*
Une inégalité, lorsqu’elle est rendue publique, réduit la contribution à un bien public de tous les participants. C’est l’injustice perçue et non les inégalités en elles-mêmes qui réduisent le consentement à financer des biens publics et par conséquent la croissance.

*Inégalités et politique publiques, Rodrik (1999)*
Les sociétés inégalitaires auraient plus de mal à mener des réformes nécessaires à la croissance. L’auteur prend l’exemple d’une économie confrontée à un choc externe. Les politiques publiques permettant de répondre aux chocs extérieurs ont des conséquences redistributives. La possibilité de les mettre en œuvre dépend grandement du climat social. S’il est mauvais et s’il s’avère impossible de mettre en place des réformes, l’économie peut être paralysé pendant des années.


