---
title: "Conscience écologique et dépenses publiques en faveur de l'environnement"
author: "Quentin Merrien, Catherine Berleur et Françoise Berleur"
date: "13/04/2021"
output: 
  html_document : 
    toc : true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

## Packages ----

library(tidyverse)
library(ggforce)
library(sf)
library(haven)
library(FactoMineR)
library(ggrepel)
library(readxl)
library(stargazer)

## Données -----

# setwd("C:/Users/quent/Desktop/ENS Paris-Saclay/1A/1S2/Econométrie/TDs/Bases de données/Documents")
setwd("~/Documents/ENS/econometrie/projet_r")
EVS <- read_dta("ZA7500_v4-0-0.dta")
dep <-read_xlsx("depenses-env.xlsx")

db <-EVS %>% 
  select(caseno, year, country, c_abrv, v7, v199, v200, v201, v202, v203, v204) %>%
  mutate(happy = as.numeric(case_when(v7 %in% c("1", "2") ~ "1", 
                                   v7 %in% c("3", "4") ~ "0",
                                   v7 %in% c("8", "9") ~ "NA")), 
         env1 = as.numeric(case_when(v199 %in% c("1","2") ~ "1", 
                          v199 %in% c("3", "4", "5") ~ "0",
                          v199 %in% c("8", "9") ~ "NA")), 
         env2 = as.numeric(case_when(v200 %in% c("1","2") ~ "1", 
                          v200 %in% c("3", "4", "5") ~"0",
                          v200 %in% c("8", "9") ~ "NA")), 
         env3 = as.numeric(case_when(v201 %in% c("1","2") ~ "1", 
                          v201 %in% c("3", "4", "5") ~"0",
                          v201 %in% c("8", "9") ~ "NA")), 
         env4 = as.numeric(case_when(v202 %in% c("1","2") ~ "1", 
                          v202 %in% c("3", "4", "5") ~"0",
                          v202 %in% c("8", "9") ~ "NA")), 
         env5 = as.numeric(case_when(v203 %in% c("1","2") ~ "1", 
                          v203 %in% c("3", "4", "5") ~"0",
                          v203 %in% c("8", "9") ~ "NA")), 
         env6 = as.numeric(case_when(v204 %in% c("1") ~ "1", 
                          v204 %in% c("2") ~"0",
                          v204 %in% c("8", "9") ~ "NA")))%>%
  group_by(country, c_abrv) %>%
  summarize(
    #effectif = n_distinct(caseno),
            happy = mean(happy == 1, na.rm = T), 
            env1 = mean(env1 == 1, na.rm = T), 
            env2 = mean(env2 == 1, na.rm = T), 
            env3 = mean(env3 == 1, na.rm = T), 
            env4 = mean(env4 == 1, na.rm = T), 
            env5 = mean(env5 == 1, na.rm = T), 
            env6 = mean(env6 == 1, na.rm = T))

db$Pays <- db$c_abrv

base_simple <- db %>%
  full_join(dep, by = "Pays")

base_simple_propre <- base_simple %>%
  filter(Pays != "NA", happy != "NA")

base_simple_propre <- base_simple_propre %>%
  select(c_abrv, happy, env1, env2, env3, env4, env5, env6, MOI_EUR_2016, PC_GDP_2016) 

#regexec() grep()

```

Pour rappel : 
v7 : Tout bien considéré, diriez-vous que vous êtes...  (p.3 de ZA7500_q_fr.pdf)
         1 – Très heureux
         2 – Assez heureux
         3 – Pas très heureux
         4 – Pas heureux du tout

à finir.
Je le ferais. 

  

Point d'analyse intéressant : 
une fois les paramètres économétriques estimés, on peut essayer d'expliquer/interpréter les situations contrefactuelles, c'est-à-dire celles qui s'éloignent le plus de l'estimation. 

Mayda et Rodrik (2005) font une étude économétrique à partir de la WVS, voir p'tet leur méthode. 

Trouver des indicateurs environnementaux supplémentaires : 
https://www.ecosia.org/search?q=indicators+of+environmental+awareness+data+base&addon=chrome&addonversion=3.3.0&method=topbar
http://jultika.oulu.fi/files/nbnfioulu-201312142043.pdf
https://www.oecd.org/env/indicators-modelling-outlooks/data-and-indicators.htm


## Régression linéaire







```{r linear-regression}
reg1 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env1) # je sais pas quoi faire avec ça, mais à approfondir
reg2 <- lm(data = base_simple_propre, formula = PC_GDP_2016 ~ env6) # je sais pas quoi faire avec ça, mais à approfondir

#summary(reg1)

# comment interpréter les résultats d'une régression avec lm : http://www.learnbymarketing.com/tutorials/linear-regression-in-r/

ggplot(data = base_simple_propre, mapping = aes(x = env5, y = PC_GDP_2016)) +
  theme_bw() +
  geom_jitter()+
  geom_smooth(method = lm) + # j'viens de découvrir : pour une droite linéaire, faut mettre method = lm, sinon, loess est pas mal 
  labs(x = "Sensibilité moyenne à l'écologie (env1)", y = "Dépenses environnementales en part de PIB") +
  theme(legend.position = "bottom") +
  scale_color_manual(name = "Les dépenses pour l'environnement sont-elles sensibles à l'opinion publique ?", values =
                       c("black","gray"))+
  guides(color = guide_legend(ncol=2, direction = "horizontal"))


```


```{r tables}

# ça marche PAS, mais c'est chelou un peu

stargazer(reg1, reg2, header = FALSE, type = 'html', notes.label = "Comments", notes = "Pas très significatif toussa, à creuser")

stargazer(base_simple_propre, header = FALSE, type = "html")

# info sur stargazer : https://www.jakeruss.com/cheatsheets/stargazer/ ou
```








## Including Plots


```{r ACP-classification}

## Données ACP et Classification

resultat_ACP <- PCA(db[, 3:9])

dbact<-as_tibble(resultat_ACP$var$coord) %>% 
  mutate(names=c(rownames(resultat_ACP$var$coord)))

dbind<-bind_cols(db,as_tibble(resultat_ACP$ind$coord))

resultat_classif <- HCPC(resultat_ACP, nb.clust = 4, graph = FALSE)

dbind<- dbind %>%
  ungroup() %>%
  mutate(groupe = resultat_classif$data.clust$clust)

europe <- st_read("Europe/europe.shp")

codes <- read.csv("all.csv") %>%
  filter(region == "Europe")%>%
  select(name, alpha.2) %>%
  mutate (NAME = name, 
          c_abrv = alpha.2)
  
carte_europe <- europe %>%
  full_join(codes, by = "NAME")

carte_europe <- carte_europe %>%
  full_join(dbind, by = "c_abrv")

test <-  as.data.frame(carte_europe) %>%
  select(-geometry)


## Graphiques ----

barplot(resultat_ACP$eig[,2],main="Figure I - Part expliquée par chaque axe dans la variance totale",
        names.arg=1:nrow(resultat_ACP$eig),col= rainbow (15))

ggplot(dbact,aes(x=Dim.1,y= Dim.2,label=names))+
  geom_point()+
  theme(legend.title=element_blank(),
        panel.background =element_rect(fill="white")) +
  geom_text(size=4,show.legend = FALSE)+
  geom_hline(yintercept=0,linetype="dashed",colour="grey")+
  geom_vline(xintercept = 0,linetype="dashed",colour="grey")+
  ggtitle("Espace des variables de l'ACP avec les axes 1 et 3") +
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%")) +
  geom_circle( aes(x0 = 0, y0 = 0, r = 1), inherit.aes = F) + 
  scale_x_continuous(limits = c(-1, 1)) +
  scale_y_continuous(limits = c(-1, 1)) +
  coord_fixed() +
  geom_segment(aes(x = 0, y = 0, xend = Dim.1, yend = Dim.2), arrow = arrow())

ggplot(data=dbind,aes(x=Dim.1,y=Dim.2))+
  ggtitle("Titre")+
  geom_point()+
  geom_text_repel(aes(label = c_abrv),size=3)+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme(plot.title=element_text(hjust=0.5),legend.position=c(.95,.2),
        panel.background =element_rect(fill="white"),legend.title=element_blank())+
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%"))

ggplot(data=dbind,aes(x=Dim.1,y=Dim.2))+
  ggtitle("Titre")+
  geom_point(aes(color=groupe))+
  geom_text_repel(aes(color=groupe,label=c_abrv),
                  size=3, max.overlaps = 20, max.iter = 1000)+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme(plot.title=element_text(hjust=0.5),
        panel.background =element_rect(fill="white"))+
  xlab(paste("Axe 1 :",round(resultat_ACP$eig[1,2],0),"%"))+
  ylab(paste("Axe 2 :",round(resultat_ACP$eig[2,2],0),"%"))+ 
  guides(color = F)

ggplot(data = carte_europe) +
  geom_sf(aes(fill = groupe)) + 
  guides(fill = F) +
  ggtitle("Figure VI - Carte des pays classifiés selon les opinions agrégées sur l'environnement") +
  coord_sf(datum = NA)





```
